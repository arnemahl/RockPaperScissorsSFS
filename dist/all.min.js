function run(t){var e=System.parameters,r=System.generated;r.strategyMatrix=Strategy.generateMatrix(e.scount);var n=System;n.players=getPlayers(e.playerCount,e.scount),Statistics.init(e.scount,r.strategyMatrix,n.players),simulate(e.gameCount,n.players,r.strategyMatrix),log.all(e.scount,r.strategyMatrix,n.players),repeat=function(t){if(!(1>t)){var n=getPlayers(e.playerCount,e.scount);simulate(e.gameCount,n,r.strategyMatrix),log.minimal(e.scount,n),repeat(--t)}},"number"==typeof t&&repeat(--t)}function simulate(t,e,r){{var n=e.slice(),a=function(t){return 2===t.length?function(){}:function(){for(var e,r,n=t.length;0!==n;)r=Math.floor(Math.random()*n),n-=1,e=t[n],t[n]=t[r],t[r]=e;return t}}(n),i=function(){var t,e;return function(n,a){return t=r[n][a],e=Math.random(),t>e}}();!function(){var e,r,n,o,c,s=300;for(logInterval=Math.round(t/s),e=0;t>e;e++)e%logInterval===0&&Statistics.collect(e),c=a(),r=c[0].play(),n=c[1].play(),o=i(r.strategy,n.strategy),o?(r.callback(r.strategy,n.strategy),n.callback(r.strategy,n.strategy)):(r.callback(n.strategy,r.strategy),n.callback(n.strategy,r.strategy))}()}}var System={parameters:{scount:4,playerCount:4,gameCount:3001},generated:{},players:[]};window.onload=function(){var t=graph_init();run(),t.draw(),fbSaveData("test")},fbSaveData=function(t){var e=new Firebase("https://rts-stats.firebaseio.com/");e.push({System:{parameters:System.parameters,generated:System.generated},statistics:Statistics.data,notes:t})};var log={strategyMatrix:function(t,e,r){var n,a,i,o="Strategy matrix (inverted):\n";for(n=0;t>n;n++){for(a=0;t>a;a++)i=e[a][n],o+=i.toFixed(2)+"   ";o+="\n"}return o},strategyEfficiency:function(t,e){var r,n,a=Strategy.getUnbiasedEfficiency(t,e);for(string="Unbiased strategy efficiency:\n",r=0;t>r;r++)n=a[r],string+=n.toFixed(2)+"   ";return string+="\n",string},playerPreference:function(t,e){var r,n,a,i=e.length,o="Player preferenes:\n";for(r=0;i>r;r++){for(a=e[r].getPreferences(),n=0;t>n;n++)val=a[n],o+=val.toFixed(2)+"   ";o+="   "+e[r].getName(),o+="\n"}return o},averagePreference:function(t,e){var r,n=Strategy.getAveragePreference(t,e),a="Average preference\n";for(r=0;r<n.length;r++)a+=n[r].toFixed(2)+"   ";return a+="\n"},preferences:function(t,e){var r=log.playerPreference(t,e)+"\n"+log.averagePreference(t,e)+"-------------------------------------------------";console.log(r)},minimal:function(t,e){var r=log.averagePreference(t,e)+"-------------------------------------------------";console.log(r)},all:function(t,e,r){var n=log.strategyMatrix(t,e)+"\n"+log.strategyEfficiency(t,e)+"\n"+log.playerPreference(t,r)+"\n"+log.averagePreference(t,r)+"-------------------------------------------------";console.log(n)}},createPlayer=function(t,e){var r=function(){for(var e=[],r=0;t>r;r++)e[r]=1/t;return e}();selectStrategy=function(){var e,n,a;return function(){for(n=0,a=Math.random(),e=0;t>e;e++)if(n+=r[e],n>a)return e;return console.log("ERROR! No strategy selected, sum total:",n),.001>1-n?(console.log("Selected last strategy and moving on"),e):void 0}}();var n=function(){var e,n;return function(){for(e=0,n=0;t>n;n++)e+=r[n];for(n=0;t>n;n++)r[n]/=e}}(),a=function(){var t=.2,e=function(){var e=.05,r=.01;return function(){t-=(t-e)*r}}(),a=function(a,i){r[a]*=1+t,r[i]*=1-t,e(),n()};return a}(),i=function(){var t;return{play:function(){return t=selectStrategy(),{strategy:t,callback:a}},getPreferences:function(){return r},getName:function(){return e}}}();return i},getPlayers=function(t,e){for(var r,n=[],a=["Arnold","Bob","Cherry"],i=0;t>i;i++)r=i<a.length?a[i]:""+i,n.push(createPlayer(e,r));return n},Statistics={data:{timings:[],strategies:[]},init:function(t){for(var e=0;t>e;e++){var r={averagePreferences:[]};Statistics.data.strategies.push(r)}},collect:function(t){var e,r,n=System.parameters.scount,a=System.players,i=Statistics.data.timings,o=Statistics.data.strategies;Statistics.collect=function(t){for(i.push(t),r=Strategy.getAveragePreference(n,a),e=0;n>e;e++)o[e].averagePreferences.push(r[e])},Statistics.collect(t)}};Calc={cumulativeMovingAverage:function(t){var e,r=0,n=(t.length,[]);for(n[0]=t[0],e=1;e<t.length;e++)r+=t[e],n[e]=r/e;return n}};var Strategy={};!function(){var t=function(t){var e=function(){var e,r=[];for(e=0;t>e;e++)r.push(Math.random());return r}(),r=function(t,r){return t=Math.pow(e[t]*Math.random(),2),r=Math.pow(e[r]*Math.random(),2),t/(t+r)};return r};Strategy.generateMatrix=function(e){var r,n,a,i=[];for(winA=t(e),r=0;e>r;r++){for(a=[],i[r]=a,n=0;r>n;n++)a[n]=1-i[n][r];for(a[n++]=.5;e>n;n++)a[n]=winA(r,n)}return i},Strategy.getUnbiasedEfficiency=function(t,e){var r,n,a=[];for(r=0;t>r;r++){for(a[r]=0,n=0;t>n;n++)a[r]+=e[r][n];a[r]/=t}return a},Strategy.getAveragePreference=function(t,e){var r,n,a,i=e.length,o=[];for(r=0;t>r;r++){for(o[r]=0,n=0;i>n;n++)a=e[n].getPreferences()[r],o[r]+=a;o[r]/=i}return o}}();var drawGraph=function(){function t(t){e=25,r=0,n=t.width-2*e,a=t.height-2*r,i=30,o=40,t=t,c=!0}var e,r,n,a,i,o,c,s=0,u=function(){var t=0,e=.37;return function(){return s++,t=(t+e)%1}}(),f=function(t,r){var o=n-e-i,c={x:function(){var r=t[t.length-1];return function(n){return e+t[n]*o/r}}(),y:function(t){return a*(1-r[t])},labelIndex:function(){var e,r,n=t.length,a=(t[1]-t[0])/2;return function(i){if(e=t.indexOf(Math.round(i)),-1!==e)return e;if(i<t[0])return 0;for(e=0;n>e;e++)if(r=t[e],Math.abs(i-r)<=a)return e;return i>r?n-1:void console.log("omgwtf",i,r,a)}}(),invX:function(){var r,n=t[t.length-1];return function(t){return label_i=(t-e)*n/o,r=c.labelIndex(label_i)}}()};return c},l=function(t,e,r,n,a,i){var o=(r-t)/2,c=(a-r)/2,s=Math.atan((r-t)/Math.abs(n-e)),u=Math.atan((a-r)/Math.abs(n-i));s=n>e?Math.PI-s:s,u=n>i?Math.PI-u:u;var f=Math.PI/2-(s+u)%(2*Math.PI)/2,l=o*Math.sin(f+s),g=o*Math.cos(f+s),y=c*Math.sin(f+u),v=c*Math.cos(f+u);return{x1:r-l,y1:n+g,x2:r+y,y2:n+v}},g=function(t,e,r){var n,a,i=e.length-1,o=["M",r.x(0),r.y(0),"C",r.x(0),r.y(0)];for(n=1;i>n;n++)a=l(r.x(n-1),r.y(n-1),r.x(n),r.y(n),r.x(n+1),r.y(n+1)),o=o.concat([a.x1,a.y1,r.x(n),r.y(n),a.x2,a.y2]);return o=o.concat([r.x(i),r.y(i),r.x(i),r.y(i)])},y=function(t,a,c,u){var f=i,l=i,g=o,y="hsl("+[a,.75,.25]+")",v="hsl("+[a,.5,.5]+")",h=t.rect(e+n-f,r+g*s,f,l).attr({fill:v,"stroke-width":0}),p=t.text(e+n-f/2,r+g*s+l/2,s).attr({fill:y,"font-size":20}),m=t.set(h,p),d=!0,S=function(){u.show(),m.animate({opacity:1},500,">"),h.animate({transform:"r0"},1e3,"elastic"),p.animate({fill:y},500,">")},M=function(){u.hide(),m.animate({opacity:.25},500,">"),h.animate({transform:"r180"},1e3,"elastic"),p.animate({fill:v},500,">")},x=function(){d=!d,d?S():M()};m.click(function(){x()}),m.hover(function(){c.toFront()})},v=function(){var t=25,e=80,r=e/1.618,n=r/3.236,a=2,i=15;return function(o,c,s,u,f,l){var g,y,v,h,p,m,d,S,M,x,P,w,b="hsl("+[f,.75,.25]+")",k="hsl("+[f,.25,.75]+")";return g=u.invX(l),d=u.x(g),S=u.y(g),M=d,x=S,d+(t+e)<o.width?d+=t:d-=t+e,S-(t+r)>0?S-=t+r:S+=t,P=d+e/2,w=S+r/2,o.setStart(),p=o.circle(M,x,1.5*a).attr({fill:b,"stroke-width":0}),h=o.path(["M",M,x,"L",P,w]).attr({stroke:b,"stroke-width":a}),y=o.rect(d,S,e,r,n).attr({fill:k,stroke:b,"stroke-width":a}),v=o.text(P,w,"x: "+c[g].toFixed(0)+"\n y: "+s[g].toFixed(3)).attr({fill:b,"font-size":i,"font-weight":700}),m=o.setFinish().attr({opacity:0,transform:"r-180"}),m.appear=function(t){return t?m.attr({opacity:1,transform:"r0"}):m.animate({opacity:1,transform:"r0"},150,"-")},m.disappear=function(t){return m.animate({opacity:0},150,"-",t)},m}}(),h=function(t,e,r,n,a,i,o){var c;i.hover(function(i,o,s){c=v(t,e,r,n,a,o).appear()},function(){c.disappear(function(){c.remove()})})},p=function(t,e,r,n,a,i,o){i.click(function(i,c,s){var u=v(t,e,r,n,a,c).appear(!0);o.push(u),u.click(function(){u.disappear(function(){u.remove()})})})};return function(e,r,n){c||t(e);var a=u(),i="hsl("+[a,.5,.5]+")",o=f(r,n),s=e.path().attr({path:g(r,n,o),stroke:i,"stroke-width":4,"stroke-linejoin":"round"}),l=e.set(s);h(e,r,n,o,a,s,l),p(e,r,n,o,a,s,l),y(e,a,s,l)}}(),graph_init=function(){var t=Raphael("graph",window.innerWidth-20,window.innerHeight-20);return{draw:function(){var e;for(e=0;e<System.parameters.scount;e++)drawGraph(t,Statistics.data.timings,Statistics.data.strategies[e].averagePreferences);for(e=0;e<System.parameters.scount;e++)drawGraph(t,Statistics.data.timings,Calc.cumulativeMovingAverage(Statistics.data.strategies[e].averagePreferences))}}};